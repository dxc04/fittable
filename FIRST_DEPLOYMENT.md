# First Deployment Instructions for Sevalla/Render

This guide walks you through the **initial deployment** of Fittable on Sevalla/Render with NeonDB.

## Prerequisites Checklist

Before starting, ensure you have:

- [ ] **NeonDB database created** at https://neon.tech
- [ ] **NeonDB connection string** copied (format: `postgres://user:password@host.neon.tech/database?sslmode=require`)
- [ ] **Gemini API key** from https://ai.google.dev/
- [ ] **Git repository** connected to Sevalla/Render
- [ ] **Email service credentials** (Mailtrap, SendGrid, or similar)

## Step 1: Initial Deployment (Will Fail - This Is Expected!)

1. Push your code to GitHub
2. Create a new Web Service on Render
3. Connect your repository
4. Render will detect `render.yaml` and configure automatically
5. **The deployment will succeed, but the app won't work yet** (database tables don't exist)

## Step 2: Configure Environment Variables

In Render Dashboard > Environment Variables, set:

### Required Variables:
```bash
# Database (CRITICAL!)
DB_URL=postgres://user:password@host.neon.tech/database?sslmode=require

# Application (will be auto-generated)
APP_KEY=(auto-generated by Render)

# AI Service (REQUIRED)
GEMINI_API_KEY=your_gemini_api_key_here

# Email Service (REQUIRED for email verification)
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io  # or your email service
MAIL_PORT=2525
MAIL_USERNAME=your_username
MAIL_PASSWORD=your_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@fittable.app
MAIL_FROM_NAME=Fittable
```

### Optional Variables (already set in render.yaml):
- APP_ENV=production
- APP_DEBUG=false
- NODE_VERSION=20.19.0
- CACHE_STORE=database
- QUEUE_CONNECTION=database
- DB_CONNECTION=pgsql

## Step 3: Run Post-Deployment Setup (CRITICAL STEP!)

After the service is deployed and environment variables are set:

1. **Open Render Shell**:
   - Go to your web service in Render dashboard
   - Click **"Shell"** in the top navigation bar
   - Wait for shell to connect

2. **Run the post-deployment script**:
   ```bash
   bash bin/post-deploy.sh
   ```

   This script will:
   - Check database connection
   - Run all migrations (creates tables)
   - Seed roles and permissions
   - Clear and rebuild caches
   - Verify tables were created

3. **Expected Output**:
   ```
   ==> Running post-deployment setup...
   ==> Checking database connection...
   ==> Running database migrations...
   Migration table created successfully.
   Migrating: 0001_01_01_000000_create_users_table
   Migrated:  0001_01_01_000000_create_users_table
   Migrating: 0001_01_01_000001_create_cache_table
   Migrated:  0001_01_01_000001_create_cache_table
   ... (more migrations)
   ==> Seeding roles and permissions...
   ==> Verifying tables...
   Users table: 0 records
   Cache table: 0 records
   Jobs table: 0 records
   Sessions table: 0 records
   ==> Post-deployment setup complete!
   ```

## Step 4: Deploy Background Worker (Optional but Recommended)

The worker is pre-configured in `render.yaml`:

1. **It should auto-deploy** with the web service
2. **If not**, create manually:
   - Type: Background Worker
   - Start Command: `php artisan queue:work --tries=3 --timeout=300`
   - Copy environment variables from web service

3. **Set these variables on the worker**:
   - `APP_KEY` (copy from web service)
   - `DB_URL` (same as web service)
   - All other variables are inherited from render.yaml

## Step 5: Verify Deployment

1. **Visit your app URL** (e.g., https://fittable.onrender.com)
2. **Test registration**: Create a new account
3. **Check email**: Verify email verification link is sent
4. **Test job analysis**: Analyze a job posting
5. **Monitor logs**: Check for any errors

## Troubleshooting

### Issue: "relation cache does not exist"

**Cause**: Post-deployment script wasn't run or failed

**Fix**:
```bash
# In Render Shell:
php artisan migrate --force
php artisan config:clear
php artisan cache:clear
```

### Issue: Database connection error during build

**This is normal!** The database is not accessible during the build phase. Migrations must be run after deployment.

### Issue: APP_KEY error

**Fix**: Render should auto-generate this. If not, run:
```bash
php artisan key:generate --force
```

### Issue: Worker not processing jobs

**Check**:
1. Worker service is running
2. Worker has same `DB_URL` as web service
3. Worker has `APP_KEY` set
4. Run migrations on web service first

### Issue: Email verification not working

**Check**:
1. All `MAIL_*` environment variables are set
2. `MAIL_FROM_ADDRESS` is valid
3. Test with Mailtrap first before using production email service

## Step 6: Future Deployments

After the initial setup is complete:

1. Push code changes to GitHub
2. Render auto-deploys
3. **No manual steps needed** (migrations already exist)
4. Application restarts automatically

## Quick Reference Commands

### Run in Render Shell:

```bash
# Check database connection
php artisan db:show

# Run migrations
php artisan migrate --force

# Seed data
php artisan db:seed --class=RoleAndPermissionSeeder --force

# Clear all caches
php artisan optimize:clear

# Rebuild caches
php artisan config:cache

# Check application status
php artisan about

# View logs
php artisan log:tail

# Check queue status
php artisan queue:monitor

# Test database query
php artisan tinker --execute="echo \DB::table('users')->count();"
```

## Support

For detailed deployment documentation, see:
- `DEPLOYMENT.md` - Full deployment guide
- `NEONDB.md` - NeonDB-specific configuration
- `README.md` - Application overview

## Success Checklist

After completing all steps, verify:

- [ ] Application loads without errors
- [ ] Can register new account
- [ ] Email verification works
- [ ] Can login
- [ ] Can analyze job posting
- [ ] Background worker processes jobs
- [ ] No "relation does not exist" errors in logs
- [ ] No "environment variable not set" warnings

**Congratulations!** Your Fittable application is now deployed and running on Sevalla/Render with NeonDB! ðŸŽ‰
